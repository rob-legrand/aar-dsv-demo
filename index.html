<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html dir="ltr" lang="en-US" xml:lang="en-US" xmlns="http://www.w3.org/1999/xhtml">
<head><title>AAR DSV demo</title>

<link href="style.css" rel="stylesheet" type="text/css" />
<meta http-equiv="Content-Type" content="application/xhtml+xml; charset=utf-8" />
<meta http-equiv="Content-Script-Type" content="text/javascript" />
<meta http-equiv="Content-Style-Type" content="text/css" />
<meta name="author" content="Rob LeGrand" />
<meta name="description" content="An interactive demo of AAR DSV and other ratings-aggregation procedures." />
<meta name="keywords" content="rob legrand, legrand, angelo state, asu, computer science, computational social choice, voting, aar dsv" />
<meta name="language" content="en-US" />
<meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0" />

<style type="text/css">
<!--
body {
   background-color: #ddeeff;
}
.outcome-choices {
   background-color: #000000;
}
#votespace {
   border: 1px solid #000000;
   background-color: #ffffff;
   display: block;
   margin-left: auto;
   margin-right: auto;
}
</style>
</head><body>
<div class="bigtop">AAR DSV demo</div>
<p>Drag the vote points around inside the votespace and the outcomes will be updated automatically.</p>
<table><tr><td>
   <div>
      <label for="select-n">Number of voters:&nbsp;</label>
      <select id="select-n">
         <option>2</option>
         <option>3</option>
         <option>4</option>
         <option selected="selected">5</option>
         <option>6</option>
         <option>7</option>
         <option>8</option>
         <option>9</option>
      </select>
   </div>
   <br />
   <fieldset class="options-area">
      <legend>Outcomes to display</legend>
      <div class="outcome-choices">
         <input id="display-per-dim-midrange" type="checkbox" /><label for="display-per-dim-midrange">&nbsp;<span style="background-color: #000000; color: #ff5555; font-weight: bold;">Per-dimension midrange</span></label><br />
         <input id="display-average" type="checkbox" /><label for="display-average">&nbsp;<span style="background-color: #000000; color: #ffaa00; font-weight: bold;">Average</span></label><br />
         <input checked="checked" id="display-aar-dsv" type="checkbox" /><label for="display-aar-dsv">&nbsp;<span style="background-color: #000000; color: #ffff00; font-weight: bold;">AAR DSV</span></label><br />
         <input id="display-fermat-weber" type="checkbox" /><label for="display-fermat-weber">&nbsp;<span style="background-color: #000000; color: #aaff00; font-weight: bold;">Fermat-Weber point</span></label><br />
         <input id="display-per-dim-median" type="checkbox" /><label for="display-per-dim-median">&nbsp;<span style="background-color: #000000; color: #55ff55; font-weight: bold;">Per-dimension median</span></label><br />
      </div>
   </fieldset>
</td><td>
   <table><tr>
      <td>(0, 1)</td>
      <td></td>
      <td>(1, 1)</td>
   </tr><tr>
      <td></td>
      <td><canvas height="601" id="votespace" width="601">
      For this demo you need a browser that supports the <code>&lt;canvas&gt;</code> element with JavaScript enabled.&nbsp; <a href="http://www.opera.com/">Opera</a> and
      <a href="http://www.google.com/chrome/">Google Chrome</a> are recommended.
      </canvas></td>
      <td></td>
   </tr><tr>
      <td>(0, 0)</td>
      <td></td>
      <td>(1, 0)</td>
   </tr></table>
</td></tr></table>

<p><a href="http://validator.w3.org/unicorn/"><img alt="[valid XHTML 1.1]" src="http://www.w3.org/Icons/valid-xhtml11-blue" /><img alt="[valid CSS]" src="http://www.w3.org/Icons/valid-css-blue" /></a></p>

<script type="text/javascript">
var runDemo = function () {

   var getTrueOffsetLeft = function (ele) {
      var n = 0;
      while (ele !== null) {
         if (ele.offsetLeft !== null) {
            n += ele.offsetLeft;
         }
         ele = ele.offsetParent;
      }
      return n;
   };

   var getTrueOffsetTop = function (ele) {
      var n = 0;
      while (ele !== null) {
         if (ele.offsetTop !== null) {
            n += ele.offsetTop;
         }
         ele = ele.offsetParent;
      }
      return n;
   };

   var x, y;
   var numVoters = 5;
   var votespaceCanvas = document.getElementById('votespace');
   var width = votespaceCanvas.width;
   var height = votespaceCanvas.height;

   if (!votespaceCanvas.getContext) {
      return;
   }

   var randomizePoints = function () {
      var i;
      x = [];
      y = [];
      for (i = 0; i < numVoters; ++i) {
         x[i] = (Math.random() - 0.5) * width;
         y[i] = (Math.random() - 0.5) * height;
      }
   };
   randomizePoints();

   var redrawSpace = function (pointBeingDragged) {
      var i;
      votespaceContext.clearRect(-width / 2, -height / 2, width, height);

      // draw vote points
      for (i = 0; i < numVoters; ++i) {
         votespaceContext.beginPath();
         votespaceContext.fillStyle = pointBeingDragged === i ? '#9966cc' : '#6699cc';
         votespaceContext.moveTo(x[i], -y[i]);
         votespaceContext.arc(x[i], -y[i], 6, 0, Math.PI * 2, true);
         votespaceContext.fill();
      }

      var sortX, sortY;
      var avgX, avgY;
      var dsvX, dsvY;
      var medX, medY;
      var midX, midY;
      var ferX, ferY;

      if (displayAverageCheckbox.checked) {
         // find Average outcome of vote points
         avgX = 0;
         avgY = 0;
         for (i = 0; i < numVoters; ++i) {
            avgX += x[i];
            avgY += y[i];
         }
         avgX /= numVoters;
         avgY /= numVoters;
      }

      if (displayPerDimMedianCheckbox.checked) {
         // find Median outcome of vote points
         sortX = x.slice(0);
         sortY = y.slice(0);
         if (numVoters % 2 === 0) {
            sortX = sortX.concat(0);
            sortY = sortY.concat(0);
         }
         sortX.sort(function (a, b) {
            return a - b;
         });
         sortY.sort(function (a, b) {
            return a - b;
         });
         medX = sortX[Math.floor(numVoters / 2)];
         medY = sortY[Math.floor(numVoters / 2)];
      }

      if (displayAarDsvCheckbox.checked) {
         // find AAR DSV outcome of vote points
         sortX = x.slice(0);
         sortY = y.slice(0);
         for (i = 1; i < numVoters; ++i) {
            sortX = sortX.concat(-width / 2 + i * width / numVoters);
            sortY = sortY.concat(-height / 2 + i * height / numVoters);
         }
         sortX.sort(function (a, b) {
            return a - b;
         });
         sortY.sort(function (a, b) {
            return a - b;
         });
         dsvX = sortX[numVoters - 1];
         dsvY = sortY[numVoters - 1];
      }

      if (displayPerDimMidrangeCheckbox.checked) {
         // find Midrange outcome of vote points
         sortX = x.slice(0);
         sortY = y.slice(0);
         sortX.sort(function (a, b) {
            return a - b;
         });
         sortY.sort(function (a, b) {
            return a - b;
         });
         midX = (sortX[0] + sortX[numVoters - 1]) / 2;
         midY = (sortY[0] + sortY[numVoters - 1]) / 2;
      }

      if (displayFermatWeberCheckbox.checked) {
         // find Fermat-Weber outcome of vote points with Weiszfeld's algorithm
         ferX = (Math.random() - 0.5) * width;
         ferY = (Math.random() - 0.5) * height;
         var numerX, numerY, denom, oldFerX, oldFerY;
         do {
            numerX = 0;
            numerY = 0;
            denom = 0;
            for (i = 0; i < numVoters; ++i) {
               sumSqDiff = (x[i] - ferX) * (x[i] - ferX) + (y[i] - ferY) * (y[i] - ferY);
               if (sumSqDiff > 0) {
                  dist = Math.sqrt(sumSqDiff);
                  numerX += x[i] / dist;
                  numerY += y[i] / dist;
                  denom += 1 / dist;
               }
            }
            oldFerX = ferX;
            oldFerY = ferY;
            ferX = numerX / denom;
            ferY = numerY / denom;
         } while (ferX > oldFerX + 0.01 || ferX + 0.01 < oldFerX || ferY > oldFerY + 0.01 || ferY + 0.01 < oldFerY);
      }

      // draw outcome points
      if (displayPerDimMidrangeCheckbox.checked) {
         votespaceContext.beginPath();
         votespaceContext.fillStyle = '#000000';
         votespaceContext.moveTo(midX, -midY);
         votespaceContext.arc(midX, -midY, 8, 0, Math.PI * 2, true);
         votespaceContext.fill();
      }
      if (displayPerDimMedianCheckbox.checked) {
         votespaceContext.beginPath();
         votespaceContext.fillStyle = '#000000';
         votespaceContext.moveTo(medX, -medY);
         votespaceContext.arc(medX, -medY, 8, 0, Math.PI * 2, true);
         votespaceContext.fill();
      }
      if (displayFermatWeberCheckbox.checked) {
         votespaceContext.beginPath();
         votespaceContext.fillStyle = '#000000';
         votespaceContext.moveTo(ferX, -ferY);
         votespaceContext.arc(ferX, -ferY, 8, 0, Math.PI * 2, true);
         votespaceContext.fill();
      }
      if (displayAverageCheckbox.checked) {
         votespaceContext.beginPath();
         votespaceContext.fillStyle = '#000000';
         votespaceContext.moveTo(avgX, -avgY);
         votespaceContext.arc(avgX, -avgY, 8, 0, Math.PI * 2, true);
         votespaceContext.fill();
      }
      if (displayAarDsvCheckbox.checked) {
         votespaceContext.beginPath();
         votespaceContext.fillStyle = '#000000';
         votespaceContext.moveTo(dsvX, -dsvY);
         votespaceContext.arc(dsvX, -dsvY, 8, 0, Math.PI * 2, true);
         votespaceContext.fill();
      }
      if (displayPerDimMidrangeCheckbox.checked) {
         votespaceContext.beginPath();
         votespaceContext.fillStyle = '#ff5555';
         votespaceContext.moveTo(midX, -midY);
         votespaceContext.arc(midX, -midY, 6, 0, Math.PI * 2, true);
         votespaceContext.fill();
      }
      if (displayPerDimMedianCheckbox.checked) {
         votespaceContext.beginPath();
         votespaceContext.fillStyle = '#55ff55';
         votespaceContext.moveTo(medX, -medY);
         votespaceContext.arc(medX, -medY, 6, 0, Math.PI * 2, true);
         votespaceContext.fill();
      }
      if (displayFermatWeberCheckbox.checked) {
         votespaceContext.beginPath();
         votespaceContext.fillStyle = '#aaff00';
         votespaceContext.moveTo(ferX, -ferY);
         votespaceContext.arc(ferX, -ferY, 6, 0, Math.PI * 2, true);
         votespaceContext.fill();
      }
      if (displayAverageCheckbox.checked) {
         votespaceContext.beginPath();
         votespaceContext.fillStyle = '#ffaa00';
         votespaceContext.moveTo(avgX, -avgY);
         votespaceContext.arc(avgX, -avgY, 6, 0, Math.PI * 2, true);
         votespaceContext.fill();
      }
      if (displayAarDsvCheckbox.checked) {
         votespaceContext.beginPath();
         votespaceContext.fillStyle = '#ffff00';
         votespaceContext.moveTo(dsvX, -dsvY);
         votespaceContext.arc(dsvX, -dsvY, 6, 0, Math.PI * 2, true);
         votespaceContext.fill();
      }
   };

   var selectNElement = document.getElementById('select-n');
   selectNElement.onchange = function () {
      numVoters = parseInt(selectNElement.options[selectNElement.selectedIndex].value, 10);
      randomizePoints();
      redrawSpace();
   };

   var displayAarDsvCheckbox = document.getElementById('display-aar-dsv');
   displayAarDsvCheckbox.onchange = redrawSpace;
   var displayAverageCheckbox = document.getElementById('display-average');
   displayAverageCheckbox.onchange = redrawSpace;
   var displayFermatWeberCheckbox = document.getElementById('display-fermat-weber');
   displayFermatWeberCheckbox.onchange = redrawSpace;
   var displayPerDimMedianCheckbox = document.getElementById('display-per-dim-median');
   displayPerDimMedianCheckbox.onchange = redrawSpace;
   var displayPerDimMidrangeCheckbox = document.getElementById('display-per-dim-midrange');
   displayPerDimMidrangeCheckbox.onchange = redrawSpace;

   var votespaceContext = votespaceCanvas.getContext('2d');
   votespaceContext.translate(width / 2, height / 2);
   redrawSpace();

   // returns the mouse location as a two-element array that gives the relative (x, y) values
   var getMouse = function (e) {
      var x = e.clientX - getTrueOffsetLeft(votespaceCanvas) + window.pageXOffset;
      var y = e.clientY - getTrueOffsetTop(votespaceCanvas) + window.pageYOffset;
      return [Math.min(width - 3, Math.max(3, x)), Math.min(height - 3, Math.max(3, y))];
   };

   votespaceCanvas.onmousedown = function (e) {
      var i, mouse = getMouse(e);
      // for each point
      for (i = 0; i < numVoters; ++i) {
         var xDiff = mouse[0] - x[i] - width / 2;
         var yDiff = height / 2 - mouse[1] - y[i];
         // if the Euclidean distance between the mouse click and this point is less than 10 pixels
         if (xDiff * xDiff + yDiff * yDiff < 100) {
            document.onmousemove = function (e) {
               var mouse = getMouse(e);
               x[i] = mouse[0] - width / 2 + i / numVoters;
               y[i] = height / 2 - mouse[1] + i / numVoters;
               redrawSpace(i);
            };
            document.onmousemove(e);
            document.onmouseup = function () {
               document.onmousemove = null;
               redrawSpace();
            };
            break;
         }
      }
      return true;
   };
};

runDemo();
</script>

</body></html>
